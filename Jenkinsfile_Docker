pipeline {
    agent {
        docker {
            image 'public.ecr.aws/lambda/python:3.10'
            args '-u 1000:1000 --entrypoint='
        }
    }

    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
    }

    stages {
        stage('Initialize Variables') {
            steps {
                script {
                    sh 'id -u'
                    sh 'id -g'
                    // --- FIX: Correct way to echo a shell command's output in a sh step ---
                    sh 'echo "Jenkins user/group ID: $(id -u):$(id -g)"'
                }
            }
        }

        stage('Checkout Source') {
            steps {
                echo 'Checking out source code from SCM...'
                checkout scm
            }
        }

        stage('Install Build Tools & Dependencies') {
            steps {
                echo 'Updating package list and installing zip...'
                sh 'yum update -y && yum install -y zip'

                echo 'Creating dependencies directory...'
                sh 'mkdir -p dependencies/python'

                dir('dependencies/python') {
                    echo 'Installing dependencies from pdf_converter_FastAPI_app/ into dedicated layer directory...'
                    sh 'pip install --target . -r ../../pdf_converter_FastAPI_app/requirements.txt'
                }
                
                // Fix for the AccessDeniedException
                sh 'sudo chown -R 1000:1000 .' 
            }
        }

        stage('Package Application and Dependencies') {
            steps {
                script {
                    def appZipFile = 'pdf_converter_app.zip'
                    def dependenciesZipFile = 'dependencies.zip'

                    echo 'Packaging application code...'
                    sh "zip -r -j ${appZipFile} pdf_converter_FastAPI_app/*"
                    
                    echo 'Packaging dependencies layer...'
                    dir('dependencies') {
                        sh "zip -r ../${dependenciesZipFile} ."
                    }
                    
                    // Fix for the AccessDeniedException
                    sh 'sudo chown -R 1000:1000 .'
                }
            }
        }

        stage('Terraform Init & Apply') {
            steps {
                script {
                    echo 'Initializing Terraform...'
                    sh 'terraform -chdir=terraform init'

                    echo 'Applying Terraform configuration...'
                    // Calculate file hashes
                    def appCodeHash = sh(script: "sha256sum pdf_converter_app.zip | awk '{print \$1}'", returnStdout: true).trim()
                    def dependenciesCodeHash = sh(script: "sha256sum dependencies.zip | awk '{print \$1}'", returnStdout: true).trim()

                    // Pass hashes to Terraform as variables
                    sh "terraform -chdir=terraform apply -auto-approve -var='app_zip_file_name=pdf_converter_app.zip' -var='app_code_hash=${appCodeHash}' -var='dependencies_zip_file_name=dependencies.zip' -var='dependencies_code_hash=${dependenciesCodeHash}'"
                }
            }
        }

        stage('Post-Deployment Info') {
            steps {
                script {
                    echo 'Gathering post-deployment information...'
                    def apiEndpoint = sh(script: 'terraform -chdir=terraform output -raw api_gateway_url', returnStdout: true).trim()
                    echo "API Gateway Endpoint: ${apiEndpoint}"
                }
            }
        }
    }
    post {
        failure {
            echo "Pipeline failed! Check logs for errors."
        }
    }
}
