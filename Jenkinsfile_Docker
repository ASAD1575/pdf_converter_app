pipeline {
    agent {
        docker {
            image 'python:3.9-slim'
            args '-u root'
        }
    }

    environment {
        AWS_ACCOUNT_ID = '375299695019'
        AWS_DEFAULT_REGION = 'us-east-1'
        APP_SOURCE_PATH = 'pdf_converter_FastAPI_app/'
        TF_PATH = 'pdf_coverter_app'
    }

    stages {
        stage('Checkout Source') {
            steps {
                script {
                    echo 'Checking out source code from SCM...'
                    checkout scm
                }
            }
        }

        // Stage: Install Python Dependencies for Lambda Deployment
        stage('Install Build Tools & Dependencies') {
            steps {
                script {
                    echo 'Updating package list and installing unzip...'
                    sh 'apt-get update && apt-get install -y unzip wget'

                    echo 'Installing AWS CLI and Python dependencies...'
                    // Use pip to install awscli, which is required by the withAWS step
                    sh 'pip install awscli'

                    // Install Python dependencies for the Lambda deployment package
                    dir("${env.APP_SOURCE_PATH}") {
                        sh 'pip install --target ./package -r requirements.txt'
                        sh 'find . -name "__pycache__" -type d -print0 | xargs -0 rm -rf || true'
                    }
                }
            }
        }

        stage('AWS Login') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    script {
                        // Export credentials as environment variables
                        env.AWS_ACCESS_KEY_ID = "${AWS_ACCESS_KEY_ID}"
                        env.AWS_SECRET_ACCESS_KEY = "${AWS_SECRET_ACCESS_KEY}"
                        
                        // Optional: confirm login
                        sh 'aws sts get-caller-identity --region $AWS_REGION'
                    }
                }
            }
        }

        stage ('Terraform Init') {
            agent {
                docker {
                    image 'hashicorp/terraform:1.5.7'
                    args '--entrypoint="" -u root:root'
                }
            }
            steps {
                script {
                    echo 'Initializing Terraform...'
                    
                    dir(env.TF){
                        sh 'terraform init -upgrade'
                    }
                }
            }
        }

        stage ('Terraform Apply') {
            agent {
                docker {
                    image 'hashicorp/terraform:1.5.7'
                    args '--entrypoint="" -u root:root'
                }
            }
            steps {
                echo 'Applying Terraform configuration...'
                
                dir(env.TF){
                    sh 'terraform apply -auto-approve'
                }
            }
        }
        
        stage('Post-Deployment Info') {
            agent {
                docker {
                    image 'hashicorp/terraform:1.5.7'
                    args '--entrypoint="" -u root:root'
                }
            }
            steps {
                script {
                    echo 'Fetching deployment outputs...'
                    dir(env.TF_PATH) {
                        def apiGatewayUrl = sh(returnStdout: true, script: 'terraform output -raw api_gateway_url').trim()
                        echo "Deployment Complete! Your application is accessible at: ${apiGatewayUrl}"
                    }
                }
            }
        }
    }  

    post {
        always {
            script {
                echo 'Cleaning up workspace...'
                // cleanWs() // Uncomment to clean the workspace after every build
            }
        }
            
        failure {
            echo 'Pipeline failed! Check logs for errors.'
        }
            
        success {
            echo 'Pipeline completed successfully!'
        }
    } 
}
